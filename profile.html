<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>친구 프로필 | MateTalk</title>
    <!-- Tailwind CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Google Fonts - Inter (Pretendard 폴백) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Pretendard 웹폰트 적용 */
        @font-face {
            font-family: 'Pretendard-Regular';
            src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff') format('woff');
            font-weight: 400;
            font-style: normal;
        }

        /* Pretendard 폰트를 기본으로 사용하고, Inter 및 sans-serif를 폴백으로 설정합니다. */
        body {
            font-family: 'Pretendard-Regular', 'Inter', sans-serif;
            background-color: #f3f4f6; /* 배경색을 약간 회색으로 설정하여 콘텐츠가 돋보이게 함 */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* 상단 정렬 */
            min-height: 100vh; /* 뷰포트 높이 전체를 차지하도록 설정 */
            margin: 0;
            padding: 0;
            overflow-y: hidden; /* 중요: body 스크롤을 막고, 앱 컨테이너 내부 스크롤만 허용 */
            -webkit-overflow-scrolling: touch; /* iOS 부드러운 스크롤 */
        }

        /* 메인 컨테이너: 모바일 화면처럼 중앙에 배치되고 최대 너비 제한, 높이 고정 */
        .main-app-container {
            width: 100%;
            max-width: 500px; /* 너비를 500px로 조정 */
            height: 100vh; /* 중요: 뷰포트 높이만큼 고정 */
            background-color: #e0f2f7; /* 하늘색 배경 (카카오톡 이미지 유사) */
            background-image: linear-gradient(to bottom, #a7d9ed, #e0f2f7); /* 하늘 그라데이션 */
            display: flex;
            flex-direction: column;
            position: relative; /* 헤더 오버레이를 위한 상대 위치 */
            overflow-y: auto; /* 프로필 내용이 길어질 경우 스크롤 가능하도록 설정 */
            -ms-overflow-style: none;  /* IE and Edge 스크롤바 숨기기 */
            scrollbar-width: none;  /* Firefox 스크롤바 숨기기 */
        }

        /* WebKit 브라우저 (Chrome, Safari) 스크롤바 숨기기 */
        .main-app-container::-webkit-scrollbar {
            display: none;
        }

        /* 헤더 스타일 (투명 오버레이) */
        .app-header {
            width: 100%;
            padding: 16px 20px; /* 좌우 패딩 */
            background-color: transparent; /* 투명 배경 */
            display: flex;
            justify-content: space-between; /* 아이콘을 양 끝으로 정렬 */
            align-items: center;
            position: absolute; /* 프로필 이미지 위에 오버레이 */
            top: 0;
            left: 0;
            right: 0;
            z-index: 20; /* 다른 요소 위에 표시 */
        }

        .header-icon {
            width: 24px;
            height: 24px;
            color: #ffffff; /* 아이콘 색상을 흰색으로 변경하여 배경 이미지와 대비 */
            filter: drop-shadow(0 1px 1px rgba(0,0,0,0.3)); /* 아이콘 가시성을 위한 그림자 */
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .header-icon:hover {
            color: #e0e0e0; /* 호버 시 약간 밝게 */
        }

        /* 프로필 정보 섹션 */
        .profile-info-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end; /* 하단으로 정렬 */
            flex-grow: 1; /* 남은 공간을 모두 차지 */
            padding-bottom: 120px; /* 하단 액션 버튼 공간 확보 */
            background-color: transparent; /* 배경색 제거 (main-app-container의 배경 사용) */
            text-align: center;
            position: relative;
            z-index: 10; /* 헤더 아래, 액션 버튼 위에 위치 */
            /* 마스크 이미지 제거 */
            mask-image: none;
            -webkit-mask-image: none;
        }

        /* 프로필 배경 이미지 (가상 요소 사용) */
        .profile-info-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 200px; /* 배경 이미지 높이 */
            background: linear-gradient(to bottom, #a7d9ed, #e0f2f7) no-repeat center center; /* 기본 배경 그라데이션 */
            background-size: cover;
            z-index: 1; /* 프로필 내용 아래에 위치 */
            filter: brightness(0.8); /* 배경 이미지를 약간 어둡게 */
        }

        /* 프로필 배경 이미지가 로드될 때 적용되는 클래스 */
        .profile-info-section.has-bg-image::before {
            background-image: var(--profile-background-image, none); /* JS에서 설정할 변수 사용 */
        }

        .profile-avatar-large {
            width: 150px; /* 큰 아바타 크기 */
            height: 150px; /* 큰 아바타 크기 */
            border-radius: 50%; /* 원형 */
            background-color: #a78bfa; /* 보라색 아바타 배경 */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 5rem; /* 글자 크기 */
            font-weight: 600;
            color: #ffffff;
            overflow: hidden;
            margin-bottom: 16px; /* 아바타와 이름 사이 간격 */
            border: 3px solid #ffffff; /* 흰색 테두리 추가 */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); /* 더 뚜렷한 그림자 */
            z-index: 5; /* 배경 이미지 위에 표시 */
        }

        .profile-avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* 이미지가 원형에 맞게 채워지도록 */
        }

        .profile-name-large {
            font-size: 2.25rem; /* 36px */
            font-weight: 700;
            color: #1f2937; /* 어두운 글자색 */
            margin-bottom: 8px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1); /* 텍스트 그림자 추가 */
            z-index: 5;
        }

        .profile-status-large {
            font-size: 1.1rem; /* 18px */
            color: #6b7280; /* 중간 회색 글자색 */
            margin-bottom: 16px; /* 상태 메시지와 버튼 사이 간격 */
            max-width: 90%;
            word-wrap: break-word;
            line-height: 1.4;
            text-shadow: 0 1px 1px rgba(0,0,0,0.05); /* 텍스트 그림자 추가 */
            z-index: 5;
        }

        /* 액션 버튼 섹션 (하단 고정) */
        .action-buttons-section {
            display: flex;
            justify-content: space-around; /* 버튼을 균등하게 분배 */
            align-items: center;
            width: 100%;
            height: 80px; /* 하단바 높이 */
            background: transparent; /* 배경을 투명으로 변경 */
            border-top: none; /* 구분선 제거 */
            position: absolute; /* 메인 컨테이너 하단에 고정 */
            bottom: 0;
            left: 0;
            z-index: 30; /* 모든 콘텐츠 위에 표시 */
            padding-bottom: env(safe-area-inset-bottom, 0px); /* 하단 안전 영역 패딩 */
        }

        .action-button-kakao {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: transparent; /* 배경색을 투명으로 변경 */
            border: none;
            color: #ffffff; /* 아이콘 및 텍스트 색상을 흰색으로 변경 */
            font-size: 0.75rem; /* 12px */
            font-weight: 500;
            cursor: default; /* 호버 효과 제거를 위해 커서 기본값으로 변경 */
            /* 그림자 강화 및 흐림 효과 추가 */
            filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.8)); /* 그림자 오프셋, 흐림, 투명도 증가 (더 검정색) */
            text-align: center;
            flex: 1; /* 공간 균등 분배 */
            padding: 8px 0; /* 상하 패딩 */
        }

        /* 호버 효과 삭제 */
        .action-button-kakao:hover {
            color: #ffffff; /* 호버 시 색상 변경 없음 */
            filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.8)); /* 호버 시 그림자 변경 없음 */
        }

        .action-button-kakao svg {
            width: 28px; /* 아이콘 크기 키움 */
            height: 28px;
            margin-bottom: 4px; /* 아이콘과 텍스트 사이 간격 */
            color: #ffffff; /* 아이콘 자체 색상도 흰색으로 변경 */
        }

        /* 호버 효과 삭제 */
        .action-button-kakao:hover svg {
            color: #ffffff; /* 호버 시 아이콘 색상 변경 없음 */
        }

        /* ID 표시 (제거) */
        .profile-id-display-bottom {
            display: none; /* 카카오톡 프로필 이미지에 ID 표시가 없으므로 숨김 */
        }

        /* 추가 정보 섹션 (제거) */
        .extra-info-section {
            display: none;
        }

        /* 메시지 박스 스타일 */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50; /* Green for success */
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 100;
            opacity: 0;
            visibility: hidden; /* 초기에는 숨김 */
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .message-box.error {
            background-color: #f44336; /* Red for error */
        }

        .message-box.show {
            opacity: 1;
            visibility: visible; /* 표시될 때 보임 */
        }

        /* 모달 스타일 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 99;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            max-width: 300px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }

        .modal-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }

        .modal-button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        .modal-button.confirm {
            background-color: #f44336;
            color: white;
        }

        .modal-button.confirm:hover {
            background-color: #d32f2f;
        }

        .modal-button.cancel {
            background-color: #e0e0e0;
            color: #333;
        }

        .modal-button.cancel:hover {
            background-color: #c0c0c0;
        }

        /* 스켈레톤 로딩 스타일 */
        .skeleton-loader {
            background-color: #e2e8f0; /* Light gray for skeleton */
            border-radius: 4px;
            animation: pulse 1.5s infinite ease-in-out; /* Pulsing animation */
        }

        .skeleton-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin-bottom: 16px;
        }

        .skeleton-name {
            width: 70%;
            height: 36px;
            margin-bottom: 8px;
        }

        .skeleton-status {
            width: 90%;
            height: 24px;
            margin-bottom: 16px;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        /* 숨김 클래스 */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="main-app-container">
        <!-- Header (Overlay) -->
        <header class="app-header">
            <!-- Close Button -->
            <svg id="closeButton" class="header-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            <!-- Edit Icon (내 프로필일 경우에만 표시) -->
            <svg id="editProfileIcon" class="header-icon hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="M15 5l4 4"/></svg>
        </header>

        <!-- 프로필 정보 섹션 -->
        <main id="profileInfoSection" class="profile-info-section">
            <div id="profileAvatarContainer" class="profile-avatar-large">
                <!-- 실제 친구 프로필 이미지 또는 이니셜로 대체될 부분 -->
                <img id="friendProfileImage" src="https://placehold.co/150x150/A78BFA/FFFFFF?text=친구" alt="친구 프로필 이미지">
                <!-- 스켈레톤 로더 -->
                <div id="skeletonAvatar" class="skeleton-avatar absolute top-0 left-0"></div>
            </div>
            <div id="friendProfileName" class="profile-name-large">친구 이름</div>
            <div id="skeletonName" class="skeleton-name absolute"></div>

            <div id="friendProfileStatus" class="profile-status-large">
                이것은 친구의 상태 메시지입니다. 기분이나 현재 상태를 나타냅니다.
            </div>
            <div id="skeletonStatus" class="skeleton-status absolute"></div>
        </main>

        <!-- 액션 버튼 섹션 (하단 고정) -->
        <section class="action-buttons-section">
            <button id="chatButton" class="action-button-kakao">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                <span>1:1 채팅</span>
            </button>
            <button id="favoriteButton" class="action-button-kakao">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                <span>즐겨찾기</span>
            </button>
            <button id="deleteFriendButton" class="action-button-kakao">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-x"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="18" x2="23" y1="6" y2="11"/><line x1="23" x2="18" y1="6" y2="11"/></svg>
                <span>친구 삭제</span>
            </button>
        </section>
    </div>

    <!-- Message Box -->
    <div id="messageBox" class="message-box"></div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-content">
            <p id="modalMessage">정말 친구를 삭제하시겠습니까?</p>
            <div class="modal-buttons">
                <button id="modalConfirmButton" class="modal-button confirm">삭제</button>
                <button id="modalCancelButton" class="modal-button cancel">취소</button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="modal-overlay">
        <div class="modal-content w-11/12 max-w-md p-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">프로필 편집</h2>

            <!-- 프로필 이미지 편집 -->
            <div class="flex flex-col items-center mb-4">
                <input type="file" id="editProfileImageInput" accept="image/*" class="hidden">
                <label for="editProfileImageInput" class="w-24 h-24 rounded-full bg-gray-200 flex items-center justify-center cursor-pointer overflow-hidden border-2 border-gray-300 shadow-sm">
                    <img id="editProfileImagePreview" src="https://placehold.co/96x96/CCCCCC/FFFFFF?text=Upload" alt="Profile Preview" class="w-full h-full object-cover">
                </label>
                <span class="text-sm text-gray-500 mt-2">프로필 사진 변경</span>
            </div>

            <!-- 배경 이미지 편집 -->
            <div class="flex flex-col items-center mb-6">
                <input type="file" id="editBackgroundImageInput" accept="image/*" class="hidden">
                <label for="editBackgroundImageInput" class="w-full h-24 bg-gray-200 flex items-center justify-center cursor-pointer overflow-hidden rounded-lg border-2 border-gray-300 shadow-sm">
                    <img id="editBackgroundImagePreview" src="https://placehold.co/400x96/E0F2F7/6B7280?text=Background" alt="Background Preview" class="w-full h-full object-cover">
                </label>
                <span class="text-sm text-gray-500 mt-2">배경 사진 변경</span>
            </div>

            <!-- 이름 입력 -->
            <div class="mb-4">
                <input type="text" id="editProfileNameInput" placeholder="이름" class="w-full p-2 border border-gray-300 rounded-md">
            </div>

            <!-- 상태 메시지 입력 -->
            <div class="mb-6">
                <textarea id="editProfileStatusInput" placeholder="상태 메시지" class="w-full p-2 border border-gray-300 rounded-md h-20 resize-none"></textarea>
            </div>

            <div class="modal-buttons">
                <button id="saveProfileChangesButton" class="modal-button confirm bg-blue-500 hover:bg-blue-600 text-white">저장</button>
                <button id="cancelEditProfileButton" class="modal-button cancel">취소</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK 가져오기
        import "https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js";
        import "https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js";
        import "https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js";

        // Canvas 환경에서 제공되는 전역 변수
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyALUv0zMoBExmhZJd2idSfmB_-DbPAAdL8",
            authDomain: "grind-mate-a.firebaseapp.com",
            projectId: "grind-mate-a",
            storageBucket: "grind-mate-a.firebasestorage.app",
            messagingSenderId: "704910171892",
            appId: "1:704910171892:web:908b2b625e46aa7a5e48a1",
            measurementId: "G-WQH66CMVP1"
        };

        // Firebase app 및 auth, firestore 인스턴스
        let app;
        let auth;
        let db;
        let currentUserId = null;
        let friendUid = null; // 현재 프로필 페이지에 표시될 친구의 UID

        // DOM 요소 가져오기
        const profileInfoSection = document.getElementById('profileInfoSection'); // 프로필 정보 섹션 (배경 이미지 적용을 위해)
        const friendProfileImage = document.getElementById('friendProfileImage');
        const friendProfileName = document.getElementById('friendProfileName');
        const friendProfileStatus = document.getElementById('friendProfileStatus');
        const chatButton = document.getElementById('chatButton');
        const favoriteButton = document.getElementById('favoriteButton');
        const deleteFriendButton = document.getElementById('deleteFriendButton');
        const closeButton = document.getElementById('closeButton');
        const messageBox = document.getElementById('messageBox');
        const editProfileIcon = document.getElementById('editProfileIcon'); // 편집 아이콘

        // 스켈레톤 로더 요소
        const skeletonAvatar = document.getElementById('skeletonAvatar');
        const skeletonName = document.getElementById('skeletonName');
        const skeletonStatus = document.getElementById('skeletonStatus');

        // 모달 관련 DOM 요소
        const confirmationModal = document.getElementById('confirmationModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmButton = document.getElementById('modalConfirmButton');
        const modalCancelButton = document.getElementById('modalCancelButton');

        // 프로필 편집 모달 관련 DOM 요소
        const editProfileModal = document.getElementById('editProfileModal');
        const editProfileImageInput = document.getElementById('editProfileImageInput');
        const editProfileImagePreview = document.getElementById('editProfileImagePreview');
        const editBackgroundImageInput = document.getElementById('editBackgroundImageInput');
        const editBackgroundImagePreview = document.getElementById('editBackgroundImagePreview');
        const editProfileNameInput = document.getElementById('editProfileNameInput');
        const editProfileStatusInput = document.getElementById('editProfileStatusInput');
        const saveProfileChangesButton = document.getElementById('saveProfileChangesButton');
        const cancelEditProfileButton = document.getElementById('cancelEditProfileButton');

        let currentProfileData = {}; // 현재 로드된 프로필 데이터를 저장할 객체 (편집 시 사용)


        // 메시지를 표시하는 유틸리티 함수
        function showMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.classList.remove('error', 'show'); // 기존 클래스 제거
            if (isError) {
                messageBox.classList.add('error');
            }
            messageBox.classList.add('show');

            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000); // 3초 후 메시지 숨김
        }

        // 모달 표시 함수
        function showModal(message, onConfirm) {
            modalMessage.textContent = message;
            confirmationModal.classList.add('show');

            const confirmHandler = () => {
                onConfirm();
                confirmationModal.classList.remove('show');
                modalConfirmButton.removeEventListener('click', confirmHandler);
                modalCancelButton.removeEventListener('click', cancelHandler);
            };

            const cancelHandler = () => {
                confirmationModal.classList.remove('show');
                modalConfirmButton.removeEventListener('click', confirmHandler);
                modalCancelButton.removeEventListener('click', cancelHandler);
            };

            modalConfirmButton.addEventListener('click', confirmHandler);
            modalCancelButton.addEventListener('click', cancelHandler);
        }

        // Firestore에서 사용자 공개 프로필을 가져오는 함수
        async function getPublicUserProfile(userId) {
            if (!db) {
                console.error('Firestore 인스턴스가 초기화되지 않았습니다.');
                return null;
            }
            const publicUserProfilesPath = `artifacts/${appId}/public/data/user_public_profiles`;
            const publicUserProfileRef = db.collection(publicUserProfilesPath).doc(userId);
            try {
                const userDoc = await publicUserProfileRef.get();
                if (userDoc.exists) {
                    console.log(`UID ${userId}에 대한 공개 프로필 가져오기 성공:`, userDoc.data());
                    return userDoc.data();
                } else {
                    console.error(`UID: ${userId}에 대한 공개 프로필 문서를 찾을 수 없습니다. 공개 프로필이 UID를 문서 ID로 저장되었는지 확인하세요.`);
                    return null;
                }
            } catch (error) {
                console.error(`UID ${userId}에 대한 공개 프로필 가져오기 오류:`, error);
                return null;
            }
        }

        // Firestore에서 사용자 개인 프로필을 가져오는 함수 (편집 모달용)
        async function getPrivateUserProfile(userId) {
            if (!db) {
                console.error('Firestore 인스턴스가 초기화되지 않았습니다.');
                return null;
            }
            const privateUserProfileRef = db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('profile').doc('user_data');
            try {
                const userDoc = await privateUserProfileRef.get();
                if (userDoc.exists) {
                    console.log(`UID ${userId}에 대한 개인 프로필 가져오기 성공:`, userDoc.data());
                    return userDoc.data();
                } else {
                    console.error(`UID: ${userId}에 대한 개인 프로필 문서를 찾을 수 없습니다.`);
                    return null;
                }
            } catch (error) {
                console.error(`UID ${userId}에 대한 개인 프로필 가져오기 오류:`, error);
                return null;
            }
        }

        // 친구의 즐겨찾기 상태를 확인하는 함수
        async function checkIfFriendIsFavorite(currentUserId, friendUid) {
            if (!db || !currentUserId || !friendUid) return false;
            const favoriteRef = db.collection('artifacts').doc(appId).collection('users').doc(currentUserId).collection('favorites').doc(friendUid);
            try {
                const doc = await favoriteRef.get();
                return doc.exists;
            } catch (error) {
                console.error('즐겨찾기 상태 확인 오류:', error);
                return false;
            }
        }

        // 즐겨찾기 상태를 토글하는 함수
        async function toggleFavorite() {
            if (!currentUserId || !friendUid) {
                showMessage('로그인 또는 친구 프로필 정보가 없습니다.', true);
                return;
            }

            const favoriteRef = db.collection('artifacts').doc(appId).collection('users').doc(currentUserId).collection('favorites').doc(friendUid);

            try {
                const isFavorite = await checkIfFriendIsFavorite(currentUserId, friendUid);
                if (isFavorite) {
                    await favoriteRef.delete();
                    showMessage('즐겨찾기에서 삭제되었습니다.');
                    favoriteButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                        <span>즐겨찾기</span>
                    `;
                } else {
                    await favoriteRef.set({
                        favoritedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showMessage('즐겨찾기에 추가되었습니다.');
                    favoriteButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                        <span>즐겨찾기</span>
                    `;
                }
            } catch (error) {
                console.error('즐겨찾기 토글 오류:', error);
                showMessage('즐겨찾기 변경에 실패했습니다.', true);
            }
        }

        // 친구를 삭제하는 함수
        async function deleteFriend() {
            if (!currentUserId || !friendUid) {
                showMessage('로그인 또는 친구 프로필 정보가 없습니다.', true);
                return;
            }

            showModal('정말 친구를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.', async () => {
                const friendRef = db.collection('artifacts').doc(appId).collection('users').doc(currentUserId).collection('friends').doc(friendUid);
                const favoriteRef = db.collection('artifacts').doc(appId).collection('users').doc(currentUserId).collection('favorites').doc(friendUid); // 즐겨찾기에서도 삭제

                try {
                    await friendRef.delete();
                    await favoriteRef.delete(); // 즐겨찾기에서도 삭제
                    showMessage('친구가 성공적으로 삭제되었습니다.');
                    // 친구 목록 페이지로 리다이렉트
                    setTimeout(() => {
                        window.location.href = '/'; // 홈 페이지로 이동 (친구 목록이 있는 페이지)
                    }, 1500);
                } catch (error) {
                    console.error('친구 삭제 오류:', error);
                    showMessage('친구 삭제에 실패했습니다.', true);
                }
            });
        }

        // 스켈레톤 로더 표시/숨김 함수
        function showSkeleton() {
            friendProfileImage.classList.add('hidden');
            friendProfileName.classList.add('hidden');
            friendProfileStatus.classList.add('hidden');
            skeletonAvatar.classList.remove('hidden');
            skeletonName.classList.remove('hidden');
            skeletonStatus.classList.remove('hidden');
        }

        function hideSkeleton() {
            friendProfileImage.classList.remove('hidden');
            friendProfileName.classList.remove('hidden');
            friendProfileStatus.classList.remove('hidden');
            skeletonAvatar.classList.add('hidden');
            skeletonName.classList.add('hidden');
            skeletonStatus.classList.add('hidden');
        }

        // 프로필 데이터를 로드하고 UI를 업데이트하는 함수
        async function loadFriendProfile(uid) {
            showSkeleton(); // 데이터 로드 시작 시 스켈레톤 표시
            const profile = await getPublicUserProfile(uid);
            if (profile) {
                friendProfileName.textContent = profile.name || '알 수 없는 친구';
                friendProfileStatus.textContent = profile.statusMessage || '상태 메시지 없음';
                if (profile.profileImageBase64) {
                    friendProfileImage.src = profile.profileImageBase64;
                } else {
                    friendProfileImage.src = `https://placehold.co/150x150/A78BFA/FFFFFF?text=${(profile.name || '친구').charAt(0)}`;
                }

                // 배경 이미지 설정
                if (profile.backgroundImageBase64) {
                    profileInfoSection.style.setProperty('--profile-background-image', `url('${profile.backgroundImageBase64}')`);
                    profileInfoSection.classList.add('has-bg-image');
                } else {
                    profileInfoSection.style.removeProperty('--profile-background-image');
                    profileInfoSection.classList.remove('has-bg-image');
                }

                // 즐겨찾기 상태 업데이트
                if (currentUserId) {
                    const isFavorite = await checkIfFriendIsFavorite(currentUserId, uid);
                    if (isFavorite) {
                        favoriteButton.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                            <span>즐겨찾기</span>
                        `;
                    } else {
                         favoriteButton.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                            <span>즐겨찾기</span>
                        `;
                    }
                }

                // 내 프로필일 경우 편집 아이콘 표시 및 친구 삭제 버튼 숨기기
                if (uid === currentUserId) {
                    editProfileIcon.classList.remove('hidden');
                    deleteFriendButton.classList.add('hidden'); // 내 프로필에서는 친구 삭제 버튼 숨김
                } else {
                    editProfileIcon.classList.add('hidden');
                    deleteFriendButton.classList.remove('hidden'); // 친구 프로필에서는 친구 삭제 버튼 표시
                }

                hideSkeleton(); // 데이터 로드 완료 시 스켈레톤 숨김
            } else {
                showMessage('친구 프로필을 불러올 수 없습니다.', true);
                friendProfileName.textContent = '프로필 없음';
                friendProfileStatus.textContent = '친구 정보를 찾을 수 없습니다.';
                friendProfileImage.src = 'https://placehold.co/150x150/CCCCCC/FFFFFF?text=Error';
                hideSkeleton(); // 오류 발생 시에도 스켈레톤 숨김
            }
        }

        // 사용자 정보를 Firestore에 저장하는 함수 (배경 이미지 필드 추가)
        async function saveUserProfile(userId, profileImageBase64, name, statusMessage, generatedId, backgroundImageBase64) {
            if (!db) {
                console.error('Firestore 인스턴스가 초기화되지 않았습니다.');
                return false;
            }
            try {
                // 1. 개인 프로필 저장 (private)
                const privateUserProfileRef = db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('profile').doc('user_data');
                await privateUserProfileRef.set({
                    profileImageBase64: profileImageBase64,
                    name: name,
                    statusMessage: statusMessage,
                    generatedId: generatedId,
                    backgroundImageBase64: backgroundImageBase64, // 배경 이미지 필드 추가
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                console.log('개인 사용자 프로필 저장 성공:', { userId, name, generatedId });

                // 2. 공개 사용자 프로필 저장 (public)
                const publicUserProfileRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_public_profiles').doc(userId);
                await publicUserProfileRef.set({
                    name: name,
                    statusMessage: statusMessage,
                    profileImageBase64: profileImageBase64,
                    backgroundImageBase64: backgroundImageBase64, // 배경 이미지 필드 추가
                    generatedId: generatedId,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                console.log('공개 사용자 프로필 저장 성공:', { userId, name, generatedId });

                // 3. 생성된 ID와 Firebase UID 매핑 저장 (public)
                const publicUserIdRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('user_ids').doc(generatedId);
                await publicUserIdRef.set({
                    userId: userId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                console.log('공개 ID 매핑 저장 성공:', generatedId);

                return true;
            } catch (error) {
                console.error('사용자 프로필 저장 오류:', error);
                showMessage('정보 저장에 실패했습니다. 다시 시도해주세요.', true);
                return false;
            }
        }


        // 프로필 편집 모달 열기
        async function openEditProfileModal() {
            if (!currentUserId) {
                showMessage('로그인된 사용자만 프로필을 편집할 수 있습니다.', true);
                return;
            }

            const myProfile = await getPrivateUserProfile(currentUserId);
            if (myProfile) {
                currentProfileData = myProfile; // 현재 프로필 데이터 저장

                editProfileNameInput.value = myProfile.name || '';
                editProfileStatusInput.value = myProfile.statusMessage || '';
                editProfileImagePreview.src = myProfile.profileImageBase64 || 'https://placehold.co/96x96/CCCCCC/FFFFFF?text=Upload';
                editBackgroundImagePreview.src = myProfile.backgroundImageBase64 || 'https://placehold.co/400x96/E0F2F7/6B7280?text=Background';

                editProfileModal.classList.add('show');
            } else {
                showMessage('내 프로필 정보를 불러올 수 없습니다.', true);
            }
        }

        // 프로필 편집 모달 닫기
        function closeEditProfileModal() {
            editProfileModal.classList.remove('show');
            // 입력 필드 초기화 (선택 사항)
            editProfileImageInput.value = '';
            editBackgroundImageInput.value = '';
        }

        // 이미지 파일 읽기 유틸리티
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsDataURL(file);
            });
        }

        // 프로필 변경 사항 저장
        async function saveEditedProfile() {
            if (!currentUserId) {
                showMessage('로그인된 사용자 정보가 없습니다.', true);
                return;
            }

            const newName = editProfileNameInput.value.trim();
            const newStatusMessage = editProfileStatusInput.value.trim();
            let newProfileImageBase64 = currentProfileData.profileImageBase64;
            let newBackgroundImageBase64 = currentProfileData.backgroundImageBase64;

            // 프로필 이미지 변경 감지 및 처리
            if (editProfileImageInput.files && editProfileImageInput.files[0]) {
                try {
                    newProfileImageBase64 = await readFileAsBase64(editProfileImageInput.files[0]);
                } catch (error) {
                    console.error('프로필 이미지 읽기 오류:', error);
                    showMessage('프로필 이미지 업로드에 실패했습니다.', true);
                    return;
                }
            }

            // 배경 이미지 변경 감지 및 처리
            if (editBackgroundImageInput.files && editBackgroundImageInput.files[0]) {
                try {
                    newBackgroundImageBase64 = await readFileAsBase64(editBackgroundImageInput.files[0]);
                } catch (error) {
                    console.error('배경 이미지 읽기 오류:', error);
                    showMessage('배경 이미지 업로드에 실패했습니다.', true);
                    return;
                }
            }

            // 변경된 내용으로 프로필 업데이트
            const success = await saveUserProfile(
                currentUserId,
                newProfileImageBase64,
                newName,
                newStatusMessage,
                currentProfileData.generatedId, // generatedId는 변경되지 않음
                newBackgroundImageBase64
            );

            if (success) {
                showMessage('프로필이 성공적으로 업데이트되었습니다.');
                closeEditProfileModal();
                // 업데이트된 프로필을 다시 로드하여 UI에 반영
                await loadFriendProfile(currentUserId);
            } else {
                showMessage('프로필 업데이트에 실패했습니다.', true);
            }
        }


        // DOMContentLoaded 이벤트 리스너
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOMContentLoaded 이벤트 발생. 앱 초기화 시작.');

            // Firebase 초기화
            if (firebaseConfig && firebaseConfig.apiKey && firebase.apps.length === 0) {
                try {
                    app = firebase.initializeApp(firebaseConfig);
                    auth = firebase.auth();
                    db = firebase.firestore();
                    console.log('Firebase 앱 및 Firestore 초기화 성공.');

                    // onAuthStateChanged는 로그인 상태 변화를 감지하므로 여기서 초기 UI 결정을 함.
                    auth.onAuthStateChanged(async (user) => {
                        if (user) {
                            currentUserId = user.uid;
                            console.log('onAuthStateChanged: 사용자 로그인됨 (UID):', user.uid);

                            // URL에서 친구 UID 추출
                            const pathSegments = window.location.pathname.split('/');
                            // 예: /profile/친구UID -> pathSegments[1] = "profile", pathSegments[2] = "친구UID"
                            if (pathSegments.length > 2 && pathSegments[1] === 'profile') {
                                friendUid = pathSegments[2];
                                console.log('URL에서 친구 UID 추출됨:', friendUid);
                                await loadFriendProfile(friendUid);
                            } else {
                                showMessage('유효한 친구 프로필 URL이 아닙니다.', true);
                                console.error('유효하지 않은 URL 형식:', window.location.pathname);
                                // 유효하지 않은 URL일 경우 홈으로 리다이렉트 고려
                                // window.location.href = '/';
                            }

                        } else {
                            currentUserId = null;
                            console.log('onAuthStateChanged: 사용자 로그아웃됨. 로그인 페이지로 리다이렉트.');
                            window.location.href = "/login"; // 로그인 페이지로 리다이렉트
                        }
                    });

                } catch (error) {
                    console.error('Firebase 앱 초기화 실패:', error);
                    showMessage('앱 초기화에 실패했습니다.', true);
                }
            } else if (firebase.apps.length > 0) {
                app = firebase.app();
                auth = firebase.auth();
                db = firebase.firestore();
                console.log('Firebase 앱이 이미 초기화되어 있습니다. 기존 인스턴스 사용.');

                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        console.log('onAuthStateChanged: 사용자 로그인됨 (UID):', user.uid);

                        const pathSegments = window.location.pathname.split('/');
                        if (pathSegments.length > 2 && pathSegments[1] === 'profile') {
                            friendUid = pathSegments[2];
                            console.log('URL에서 친구 UID 추출됨:', friendUid);
                            await loadFriendProfile(friendUid);
                        } else {
                            showMessage('유효한 친구 프로필 URL이 아닙니다.', true);
                            console.error('유효하지 않은 URL 형식:', window.location.pathname);
                            // window.location.href = '/';
                        }
                    } else {
                        currentUserId = null;
                        console.log('onAuthStateChanged: 사용자 로그아웃됨. 로그인 페이지로 리다이렉트.');
                        window.location.href = "/login";
                    }
                });
            } else {
                console.warn('Firebase 설정이 올바르게 제공되지 않았습니다. 기능이 작동하지 않을 수 있습니다.');
                showMessage('Firebase 설정 오류. 관리자에게 문의하세요.', true);
            }
        });

        // 이벤트 리스너
        if (closeButton) {
            closeButton.addEventListener('click', () => {
                window.history.back(); // 뒤로가기
            });
        }

        if (chatButton) {
            chatButton.addEventListener('click', () => {
                if (friendUid) {
                    showMessage(`${friendUid}님과 1:1 채팅 시작! (실제 채팅 페이지로 이동)`, false);
                    // 실제 앱에서는 여기에 채팅 페이지로 이동하는 로직을 구현합니다.
                    // 예: window.location.href = `/chat/${friendUid}`;
                }
            });
        }

        if (favoriteButton) {
            favoriteButton.addEventListener('click', toggleFavorite);
        }

        if (deleteFriendButton) {
            deleteFriendButton.addEventListener('click', deleteFriend);
        }

        // 편집 아이콘 클릭 이벤트
        if (editProfileIcon) {
            editProfileIcon.addEventListener('click', openEditProfileModal);
        }

        // 프로필 이미지 입력 변경 시 미리보기 업데이트
        if (editProfileImageInput) {
            editProfileImageInput.addEventListener('change', async (event) => {
                if (event.target.files && event.target.files[0]) {
                    const base64 = await readFileAsBase64(event.target.files[0]);
                    editProfileImagePreview.src = base64;
                }
            });
        }

        // 배경 이미지 입력 변경 시 미리보기 업데이트
        if (editBackgroundImageInput) {
            editBackgroundImageInput.addEventListener('change', async (event) => {
                if (event.target.files && event.target.files[0]) {
                    const base64 = await readFileAsBase64(event.target.files[0]);
                    editBackgroundImagePreview.src = base64;
                }
            });
        }

        // 프로필 변경 저장 버튼
        if (saveProfileChangesButton) {
            saveProfileChangesButton.addEventListener('click', saveEditedProfile);
        }

        // 프로필 편집 취소 버튼
        if (cancelEditProfileButton) {
            cancelEditProfileButton.addEventListener('click', closeEditProfileModal);
        }
    </script>
</body>
</html>
